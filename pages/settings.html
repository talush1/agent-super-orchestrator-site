<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Settings | ASO</title><link rel="stylesheet" href="../styles.css"></head>
<body>
<header><nav><a href="../index.html">Home</a> | <a href="./compose.html">Compose</a> | <a href="./inbox.html">Inbox</a></nav><h1>Settings</h1></header>
<main>
  <div class="card">
    <h3>Backend URL</h3>
    <label>API Base URL</label><input id="apiBase" placeholder="https://aso-proxy.onrender.com">
    <button onclick="saveApi()">Save</button>
  </div>
  <div class="card">
    <h3>Push Notifications</h3>
    <button onclick="enablePush()">Enable Push</button> <button onclick="testPush()">Send Test</button>
  </div>
</main>
<script src="../api.js"></script>
<script>
function saveApi(){ const url=document.getElementById('apiBase').value.trim(); localStorage.setItem('aso:apiBase',url); alert('Saved'); }
async function enablePush(){
  if(!('serviceWorker'in navigator)) return alert('No SW');
  const reg = await navigator.serviceWorker.ready;
  const keyResp = await api.get('/api/push/public-key').then(r=>r.json()).catch(()=>({publicKey:null}));
  if(!keyResp.publicKey) return alert('Server missing VAPID public key');
  const key = urlBase64ToUint8Array(keyResp.publicKey);
  const sub = await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey:key });
  await api.post('/api/push/subscribe', sub);
  alert('Subscribed');
}
async function testPush(){ await api.post('/api/push/test',{}); alert('Requested'); }
function urlBase64ToUint8Array(s){const p='='.repeat((4-s.length%4)%4);const b=(s+p).replace(/-/g,'+').replace(/_/g,'/');const d=atob(b);const a=new Uint8Array(d.length);for(let i=0;i<d.length;i++)a[i]=d.charCodeAt(i);return a;}
</script>
</body></html>